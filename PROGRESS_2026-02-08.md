Progress Log - 2026-02-08

**Context**
- Branch: `step5-auth-enforcement`
- Goal: security hardening and auditability with zero gameplay/contract changes.
- Rule: server authoritative identity; do not trust client-sent `playerId`/timestamps.

**Completed (committed)**
- Centralized Supabase config and removed hardcoded fallback; added explicit env checks and clearer startup errors.
- Fixed teleport visibility/movement sync issues and aligned cross-map respawn stats.
- Stopped tracking `.env` files; added `.env.example`.
- Added auth audit logs and movement audit logs with opt-in env flags.
- Enforced auth token match on HTTP API (`/api/player-data/:authId`).
- Enforced auth token on WS join.
- Added global monitor token gate (optional).
- Persistence identity audit logging.
- Clarified shared security boundary.
- Rate-limited `request_player_data` (1/s) and `save_request` (1/5s).
- Server-side: `request_player_data` and `save_request` validation now clientId-only.
- Client-side: align `request_player_data`/`save_request` payloads to clientId-only.
- Server-side: skill upgrade authority clientId-only.
- Server-side: start_combat and projectile_fired authority clientId-only.
- Combat payload alignment committed (client->server uses clientId; server broadcasts userId).
- Improved damage text readability (outline) and nickname readability.
- Fixed start_combat log crash (playerData initialization order).
- Added stop_combat debug log gated by `DEBUG_COMBAT=true`.

**Tests Completed**
- HTTP API: valid token OK, invalid token 401, mismatched authId 401.
- Global monitor token: correct token OK, wrong token ACCESS_DENIED.
- Movement audit: skew/missing clientTimestamp logged.
- Rate limits: `request_player_data` and `save_request` blocked as expected.
- Smoke test (2026-02-08): start combat, fire projectile, stop combat; no server errors. Note: stop_combat log appears only with `DEBUG_COMBAT=true`; global state shows 0 combats after stop.

**Work In Progress (uncommitted)**
- None (clean working tree).

**Remaining Next Steps (when ready)**
- If needed, re-run smoke test with `DEBUG_COMBAT=true` to see explicit stop_combat logs.
- Optional: clean up `StopCombatMessage` (and possibly `ProjectileFiredMessage`) typing to distinguish client->server vs server->client payloads.

**How To Resume Tomorrow**
1) `git status -sb` should be clean.
2) Optional: run smoke test with `DEBUG_COMBAT=true` if you want explicit stop logs.
3) Decide on typing cleanup for `StopCombatMessage` / `ProjectileFiredMessage`.

**Audit Snapshot (as provided)**
Di seguito l’audit conservativo richiesto. Nessuna modifica al codice. Mi baso solo su struttura e file di codice esistenti.

**1. Discovered Modules Overview**
- `server/entry (server.cjs)` — Entry point HTTP+WS, bootstrap, env, lifecycle — Risk: HIGH  
- `server/core/connection` — Routing messaggi WS, validazione, auth, rate limit — Risk: HIGH  
- `server/core/map` — Tick mappe, broadcast posizione, movement validation — Risk: HIGH  
- `server/core/database` — RPC Supabase, load/save player state — Risk: HIGH  
- `server/core/respawn` — Respawn orchestration, stats reset, penalties — Risk: HIGH  
- `server/managers` — NPC/combat/projectile/quest/repair/hazard — Risk: HIGH  
- `server/config` — Costanti server, map configs — Risk: MEDIUM  
- `server/core/messaging` — Formattazione messaggi (welcome, join, leaderboard) — Risk: MEDIUM  
- `server/core/infrastructure` — FixedLoop, logging wrappers — Risk: MEDIUM  
- `server/core/debug` — Global monitor (admin) — Risk: MEDIUM  
- `server/logger.cjs` — Logging & counters — Risk: LOW  
- `shared` — Config condivise + SecurityBoundary — Risk: HIGH  
- `supabase` — Migrations/RPC/Edge functions — Risk: HIGH  
- `src/infrastructure` — ECS, engine, display — Risk: HIGH  
- `src/core` — Utils/Domain/Architecture/Services — Risk: HIGH  
- `src/entities` — Componenti ECS — Risk: MEDIUM  
- `src/systems` — Gameplay systems (combat/AI/physics/render/economy/quest/input/ui) — Risk: HIGH  
- `src/multiplayer/client` — Network client, handlers, managers — Risk: HIGH  
- `src/presentation/ui` — UI e manager UI — Risk: MEDIUM  
- `src/game` — Stati di gioco e bootstrap — Risk: MEDIUM  
- `src/factories` — Factory entità — Risk: MEDIUM  
- `src/config` — Config runtime client — Risk: MEDIUM  
- `src/lib` — Supabase client (client-side) — Risk: MEDIUM  
- `electron` — Wrapper desktop, updater — Risk: MEDIUM  
- `tools` — Script dev/ops — Risk: LOW  
- `public` — Asset e JSON pubblici — Risk: MEDIUM  
- `.github` — CI/automation — Risk: LOW  
- `build/dist*/dist-electron/dist-server/client` — Artifacts/legacy — Risk: LOW  

---

**2. Detailed Module Audit**

**`server/entry (server.cjs)`**  
- Responsibility summary: bootstrap runtime, HTTP API, WS server, env, rate limit.  
- Dependencies (in/out): in: `server/core/*`, `server/managers/*`, `server/config/*`, `shared/*`; out: client HTTP/WS.  
- Problems detected: monolite (HTTP+WS in un file), molte responsabilità in un punto; CORS default permissivo (`ALLOWED_ORIGIN`), in-memory rate limit.  
- Security / exploit notes: endpoint `/api/player-data/:authId` non verifica che il token appartenga a `authId` (si limita a controllare che `Authorization` esista); rischio data-leak se RPC non protegge correttamente.  
- Refactor suggestions (if ANY):  
  - Scope: `server.cjs` — isolare handler API in funzioni pure nello stesso file (solo estrazione) — preserve behavior: chiamate identiche — reversible: revert singolo file — risk reduced: leggibilità e auditabilità.  
- Do-not-touch notes: routing API/WS e handshake sono critici live.

**`server/core/connection`** (`server/core/connection/MessageRouter.cjs`, `WebSocketConnectionManager.cjs`)  
- Responsibility summary: validazione input, routing messaggi, anti-cheat, map change, respawn.  
- Dependencies (in/out): in: `server/core/database/PlayerDataManager.cjs`, `server/core/map/*`, `server/core/respawn/*`, `shared/SecurityBoundary.cjs`; out: gameplay state e broadcast.  
- Problems detected: god file (`MessageRouter.cjs`), accoppiamento implicito con `mapManager` e `mapServer`, molte magic values (cooldown, range, threshold), flow di respawn con path divergenti.  
- Security / exploit notes: uso di `clientTimestamp` per validazioni; se manipolato può ridurre l’efficacia anti-speed.  
- Refactor suggestions (if ANY):  
  - Scope: `server/core/connection/MessageRouter.cjs` — estrarre costanti in cima file (no behavior change) — reversible: revert single file — risk reduced: riduce errori su magic values.  
- Do-not-touch notes: `handlePositionUpdate`, `handlePortalUse`, `handlePlayerRespawnRequest` sono high-risk.

**`server/core/map`** (`server/core/map/*`)  
- Responsibility summary: tick mappe, broadcast, validazioni movimento, interest radius.  
- Dependencies (in/out): in: `server/core/connection` (queue), `server/core/InputValidator.cjs`; out: broadcast `remote_player_update`, npc updates.  
- Problems detected: dipendenza da `global.inputValidator`; uso di timestamp client per validazione; queue per posizione con update drop.  
- Security / exploit notes: time-warp possibile via `clientTimestamp`; se un client manipola time, può bypassare check velocità.  
- Refactor suggestions (if ANY):  
  - Scope: `server/core/map/PositionUpdateProcessor.cjs` — documentare esplicitamente trust model su `clientTimestamp` (solo comment) — preserve behavior — reversible — risk reduced: audit clarity.  
- Do-not-touch notes: broadcast e queue sono fondamentali per la sincronizzazione.

**`server/core/database`** (`server/core/database/PlayerDataManager.cjs`)  
- Responsibility summary: load/save player data via RPC Supabase.  
- Dependencies (in/out): in: `server/config/supabase.cjs`, `shared/player-config.json`; out: connection manager, quest manager.  
- Problems detected: parsing JSON eterogeneo, fallback e recovery paths; schema coupling ai nomi RPC; error handling complessa.  
- Security / exploit notes: usa service role key; se esposta è compromesso completo DB.  
- Refactor suggestions (if ANY):  
  - Scope: `server/core/database/PlayerDataManager.cjs` — estrarre nomi RPC in costanti locali — behavior preserved — reversible — risk reduced: riduce errori di typo.  
- Do-not-touch notes: load/save e RPC sono core persistence.

**`server/core/respawn`** (`RespawnCoordinator.cjs`, `RespawnSystem.cjs`, `PlayerStatsSystem.cjs`, `PenaltySystem.cjs`)  
- Responsibility summary: pipeline respawn e penalità.  
- Dependencies (in/out): in: `server/managers/*` (damage), `server/core/map`; out: player state, broadcast respawn.  
- Problems detected: doppie strade di respawn (migrazione vs locale); molte assunzioni implicite su maxHP/maxShield.  
- Security / exploit notes: se `playerData.maxHealth` manca, fallback usa valori hardcoded; potenziale desync.  
- Refactor suggestions (if ANY):  
  - Scope: `server/core/respawn/*` — aggiungere assert/guard con logging (solo log, nessun change) — behavior preserved — reversible — risk reduced: diagnosi più rapida.  
- Do-not-touch notes: respawn è gameplay-critical.

**`server/managers`**  
- Responsibility summary: logica gameplay server-side (NPC, combat, projectile, quest, repair, hazard).  
- Dependencies (in/out): in: `server/core/map-server.cjs`, `server/config/*`, `shared/*`; out: map state, broadcasts.  
- Problems detected: coupling forte con mapServer; alcuni path “hack” e recovery; `quest-manager.cjs` usa `player_id` vs `auth_id` (schema mismatch potenziale).  
- Security / exploit notes: quest rewards e inventory update server-side ok, ma key mismatch può causare perdita dati o exploit di persistenza.  
- Refactor suggestions (if ANY):  
  - Scope: `server/managers/quest-manager.cjs` — solo commenti espliciti su chiave primaria usata (auth_id vs player_id) — preserve behavior — reversible — risk reduced: evita regressioni.  
- Do-not-touch notes: combat e projectile sono core.

**`server/config`**  
- Responsibility summary: map configs, constants.  
- Dependencies (in/out): in: none; out: server core/managers.  
- Problems detected: magic values embedded (range, counts, portal positions) senza centralizzazione per tuning.  
- Security / exploit notes: None dirette.  
- Refactor suggestions (if ANY):  
  - Scope: `server/config/MapConfigs.cjs` — commentare invariants (dimensioni mappe, portal positions) — preserve behavior — reversible.  
- Do-not-touch notes: map layout è gameplay.

**`server/core/messaging`**  
- Responsibility summary: formattazione messaggi WS.  
- Dependencies (in/out): in: `server/core/*`; out: client handlers.  
- Problems detected: schema messaggi duplicato tra server e client types; rischio drift.  
- Security / exploit notes: se client accetta campi opzionali non validati, può generare phantom state.  
- Refactor suggestions (if ANY):  
  - Scope: `server/core/messaging/MessageBroadcaster.cjs` — consolidare campi comuni in helper interno (no change) — reversible.  
- Do-not-touch notes: contratti messaggi sono live.

**`server/core/infrastructure`**  
- Responsibility summary: loop server, logging wrappers.  
- Dependencies (in/out): in: none; out: map tick, logging.  
- Problems detected: FixedLoop è sensibile a stall; tuning hardcoded.  
- Security / exploit notes: None dirette.  
- Refactor suggestions (if ANY): None (behavior delicate).  
- Do-not-touch notes: FixedLoop.

**`server/core/debug`**  
- Responsibility summary: global monitor admin.  
- Dependencies (in/out): in: map state; out: debug info.  
- Problems detected: potenziale leakage se esposto a non-admin (dipende da auth).  
- Security / exploit notes: assicurarsi che solo admin ricevano; già protetto in router.  
- Refactor suggestions (if ANY): None.

**`server/logger.cjs`**  
- Responsibility summary: logging centralizzato e counters.  
- Dependencies (in/out): in: none; out: log stream.  
- Problems detected: None evidenti.  
- Security / exploit notes: log può contenere dati sensibili se non filtrati.  
- Refactor suggestions (if ANY): None.

**`shared`** (`shared/*.json`, `shared/SecurityBoundary.cjs`)  
- Responsibility summary: single source configs + trust model.  
- Dependencies (in/out): in: none; out: client+server.  
- Problems detected: duplicazione config (`src/config/npcConfig.json` vs `shared/npc-config.json`); SecurityBoundary è policy “soft” (non enforcement reale).  
- Security / exploit notes: whitelist message types include typo (`equp_item`) potenziale drift contrattuale.  
- Refactor suggestions (if ANY):  
  - Scope: `shared/SecurityBoundary.cjs` — commentare alias legacy dei message types (nessun cambio) — reversible.  
- Do-not-touch notes: trust model è critico.

**`supabase`**  
- Responsibility summary: schema DB, RPC, edge functions.  
- Dependencies (in/out): in: Supabase runtime; out: server RPC contracts.  
- Problems detected: possibili mismatch schema tra migrations e edge function (`user_id` vs `auth_id`); più versioni di migration per health/shield.  
- Security / exploit notes: RPC SECURITY DEFINER con service role; se endpoint non verifica identità, rischio escalation.  
- Refactor suggestions (if ANY):  
  - Scope: `supabase/functions/*` — commenti di compatibilità schema (no change).  
- Do-not-touch notes: migrations e RPC live.

**`src/infrastructure`** (`engine`, `ecs`, `display`)  
- Responsibility summary: loop client, ECS, display scaling.  
- Dependencies (in/out): in: `src/core/utils`, `src/config`; out: systems rendering/logic.  
- Problems detected: error boundary solo lato ECS; thread worker; alcuni codici di commento legacy.  
- Security / exploit notes: client-side only; non fidarsi per server authority.  
- Refactor suggestions (if ANY): None (high coupling).

**`src/core`** (`domain`, `architecture`, `utils`, `services`, `settings`)  
- Responsibility summary: logica dominio, utils, configurazione interna.  
- Dependencies (in/out): in: `shared/*`, `src/config/*`; out: systems, multiplayer.  
- Problems detected: boundary poco chiaro tra domain e systems; duplicazioni “stat reset” vs server.  
- Security / exploit notes: qualunque logica “autorità” lato client è solo UX.  
- Refactor suggestions (if ANY): None (boundaries unclear).  
- Do-not-touch notes: domain logic accoppiata a systems.

**`src/entities`**  
- Responsibility summary: componenti ECS (Transform, Health, Shield, NPC, Player).  
- Dependencies (in/out): in: none; out: systems.  
- Problems detected: molti componenti “data-only” senza invariants.  
- Security / exploit notes: client-side only.  
- Refactor suggestions (if ANY): None.

**`src/systems`**  
- Responsibility summary: gameplay systems client (combat, AI, physics, rendering, economy, quest, input, multiplayer, UI).  
- Dependencies (in/out): in: entities, core, config; out: ECS and UI.  
- Problems detected: system order manual in `src/systems/game/SystemConfigurator.ts`; cross-deps; special casing; magic values.  
- Security / exploit notes: qualsiasi logica combat/loot client non deve essere trustata; server deve rimanere autoritativo.  
- Refactor suggestions (if ANY):  
  - Scope: `src/systems/game/SystemConfigurator.ts` — isolare mapping dipendenze in costanti (solo refactor locale) — reversible.  
- Do-not-touch notes: combat, movement, quest.

**`src/multiplayer/client`**  
- Responsibility summary: networking client, message routing, rate limiting client-side.  
- Dependencies (in/out): in: `src/config/NetworkConfig.ts`, `src/systems/*`; out: WS messages.  
- Problems detected: `ClientNetworkSystem.ts` è god object, uso esteso di `any`; handlers frammentati.  
- Security / exploit notes: rate limiting client non è sicurezza; server deve sempre validare.  
- Refactor suggestions (if ANY): None (high coupling / risk of contract drift).

**`src/presentation/ui`**  
- Responsibility summary: UI panels, popups, HUD, chat, settings.  
- Dependencies (in/out): in: systems, core utils; out: DOM.  
- Problems detected: coupling forte con sistemi specifici; state in DOM.  
- Security / exploit notes: None dirette.  
- Refactor suggestions (if ANY): None.

**`src/game`**  
- Responsibility summary: stati (StartState/PlayState), bootstrap main.  
- Dependencies (in/out): in: infrastructure/engine; out: systems.  
- Problems detected: transizioni stato con side effects forti.  
- Security / exploit notes: None dirette.  
- Refactor suggestions (if ANY): None.

**`src/factories`**  
- Responsibility summary: creazione entità gioco.  
- Dependencies (in/out): in: entities; out: systems.  
- Problems detected: coupling con asset pipeline; hardcoded sprite mapping.  
- Security / exploit notes: None.  
- Refactor suggestions (if ANY): None.

**`src/config`**  
- Responsibility summary: config client, NetworkConfig, AudioConfig, GameConstants.  
- Dependencies (in/out): in: `shared/*`; out: systems.  
- Problems detected: file duplicati (`src/config/npcConfig.json` non usato).  
- Security / exploit notes: `NetworkConfig` impone WSS in prod, corretto.  
- Refactor suggestions (if ANY): None (avoid contract drift).

**`src/lib`** (`SupabaseClient.ts`)  
- Responsibility summary: auth client + API wrapper.  
- Dependencies (in/out): in: `src/config/NetworkConfig.ts`; out: HTTP to server.  
- Problems detected: logica di update quest con fallback ambiguo; dipendenza da endpoint custom.  
- Security / exploit notes: client non deve mai accedere DB direttamente; qui usa server API.  
- Refactor suggestions (if ANY): None.

**`electron`**  
- Responsibility summary: wrapper desktop, updater, window lifecycle.  
- Dependencies (in/out): in: build assets; out: app shell.  
- Problems detected: none critici; hardcoded URLs.  
- Security / exploit notes: ensure no nodeIntegration (già disabilitato).  
- Refactor suggestions (if ANY): None.

**`tools`**  
- Responsibility summary: script setup/verify.  
- Dependencies (in/out): in: filesystem; out: dev automation.  
- Problems detected: none.  
- Security / exploit notes: None.  
- Refactor suggestions (if ANY): None.

**`public`**  
- Responsibility summary: asset e JSON pubblici.  
- Dependencies (in/out): in: none; out: asset load.  
- Problems detected: configurazioni duplicate rispetto a `shared/`.  
- Security / exploit notes: public assets sono attaccabili via tamper locale (solo client).  
- Refactor suggestions (if ANY): None.

**`.github`**  
- Responsibility summary: CI.  
- Dependencies (in/out): in: repo; out: automation.  
- Problems detected: not audited in depth.  
- Security / exploit notes: assicurare secrets non loggati.  
- Refactor suggestions (if ANY): None.

**`build/dist*/dist-electron/dist-server/client`**  
- Responsibility summary: artifacts/legacy.  
- Dependencies (in/out): generated.  
- Problems detected: none (non-runtime).  
- Security / exploit notes: non applicabile.  
- Refactor suggestions (if ANY): None.
